# Railway Dockerfile - Using Node.js LTS
FROM node:18-bullseye-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# 1. 进入 /app/backend 工作目录
WORKDIR /app/backend

# 2. 先仅 COPY backend/package*.json ./
COPY backend/package*.json ./

# 3. 执行 npm ci --include=dev (不会触发postinstall,因为已移除)
RUN npm cache clean --force
RUN npm ci --include=dev

# 验证 TypeScript 安装
RUN npx tsc --version

# 4. 再 COPY backend/ ./ (包含tsconfig.json和src/)
COPY backend/ ./

# 验证必要文件存在
RUN ls -la package.json tsconfig.json src/

# Copy data directory to parent level
COPY data /app/data

# 5. 最后 RUN npm run build (此时tsconfig.json已存在)
RUN npm run build

# 验证构建结果
RUN ls -la dist/

# Clean up devDependencies after build for smaller image (optional)
# RUN npm prune --production

# Expose port
EXPOSE 3001

# Start command
CMD ["npm", "start"]